<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
    <script src="jquery-3.7.1.js"></script>
  </head>
  <body>
    <div class="game_scene">
      <div class="left_part">
        <div class="row row0">
          <div class="card" id="0">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="1">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="2">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="3">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="4">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="5">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row1">
          <div class="card" id="6">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="7">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="8">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="9">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="10">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="11">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row2">
          <div class="card" id="12">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="13">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="14">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="15">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="16">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="17">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row3">
          <div class="card" id="18">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="19">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="20">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="21">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="22">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card" id="23">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
      </div>
      <div class="right_part">
        <div id="stopwatchText">Time</div>
        <!-- 設計碼表(stopwatch)，計時玩家遊玩時間 -->
        <p id="stopwatch">
          <span id="minutes_tens">0</span>
          <span id="minutes_units">0</span>
          <span id="colon">:</span>
          <span id="seconds_tens">0</span>
          <span id="seconds_units">0</span>
        </p>
      </div>
    </div>

    <!-- 遊戲結束框 -->
    <!-- <div class="wrap">
      <a class="btn popup-btn" href="#letmeopen">打開popup視窗</a>
    </div> -->
    <div class="popup-wrap" id="letmeopen">
      <div class="popup-box transform-out">
        <h2>遊戲結束！</h2>
        <!-- <h3>內容可以打很多在這裡</h3> -->
        <a class="close-btn popup-close" href="#">x</a>
      </div>
    </div>
    <!-- 遊戲結束框 -->
    <script>
      // 設定卡牌的圖片資料: 圖組別、圖來源、被翻次數
      let all_cards_data = [
        ["p0", "background-image: url(img/Hanafuda/p0_January_Hikari.png);"],
        ["p0", "background-image: url(img/Hanafuda/p0_January_Hikari.png);"],
        ["p1", "background-image: url(img/Hanafuda/p1_March_Hikari.png);"],
        ["p1", "background-image: url(img/Hanafuda/p1_March_Hikari.png);"],
        ["p2", "background-image: url(img/Hanafuda/p2_August_Hikari.png);"],
        ["p2", "background-image: url(img/Hanafuda/p2_August_Hikari.png);"],
        ["p3", "background-image: url(img/Hanafuda/p3_November_Hikari.png);"],
        ["p3", "background-image: url(img/Hanafuda/p3_November_Hikari.png);"],
        ["p4", "background-image: url(img/Hanafuda/p4_December_Hikari.png);"],
        ["p4", "background-image: url(img/Hanafuda/p4_December_Hikari.png);"],
        ["p5", "background-image: url(img/Hanafuda/p5_February_Tane.png);"],
        ["p5", "background-image: url(img/Hanafuda/p5_February_Tane.png);"],
        ["p6", "background-image: url(img/Hanafuda/p6_July_Tane.png);"],
        ["p6", "background-image: url(img/Hanafuda/p6_July_Tane.png);"],
        ["p7", "background-image: url(img/Hanafuda/p7_May_Tane.png);"],
        ["p7", "background-image: url(img/Hanafuda/p7_May_Tane.png);"],
        ["p8", "background-image: url(img/Hanafuda/p8_March_Kasu_2.png);"],
        ["p8", "background-image: url(img/Hanafuda/p8_March_Kasu_2.png);"],
        ["p9", "background-image: url(img/Hanafuda/p9_October_Kasu_1.png);"],
        ["p9", "background-image: url(img/Hanafuda/p9_October_Kasu_1.png);"],
        ["p10", "background-image: url(img/Hanafuda/p10_December_Kasu_2.png);"],
        ["p10", "background-image: url(img/Hanafuda/p10_December_Kasu_2.png);"],
        ["p11", "background-image: url(img/Hanafuda/p11_October_Tane.png);"],
        ["p11", "background-image: url(img/Hanafuda/p11_October_Tane.png);"],
      ];

      // 設定卡牌數量(常數)
      const card_qty = all_cards_data.length;

      // 宣告堆疊
      let stack = null;

      // 定義用以計時的變數interval
      let interval = 0;
      let seconds = 0;
      let minutes = 0;

      // 用Promise達到延遲時間
      let delay = function (s) {
        return new Promise(function (resolve, reject) {
          setTimeout(resolve, s);
        });
      };

      // 檯面上剩餘卡牌數量 (未使用)
      let unused_card_qty = card_qty;

      function Stack() {
        // 定義堆疊，存放代表卡牌ID的字串。
        let items = [];

        function push(id_string) {
          if (!check_is_full() && peek() != id_string) {
            flip_card(parseInt(id_string));
            items.push(id_string);
            return true;
          } else {
            return false;
          }
        }

        function pop() {
          return items.pop();
        }

        function peek() {
          // 查看最上方的item
          if (!items.length) {
            // 要是堆疊為空，回傳空字串。
            return "";
          } else {
            return items[items.length - 1];
          }
        }

        function check_is_full() {
          if (items.length == 2) {
            return true;
          } else {
            return false;
          }
        }

        return {
          push,
          pop,
          peek,
          check_is_full,
        };
      }

      function shuffle_array(array) {
        // 洗圖順序
        // Fisher-Yates Shuffle 演算法
        // 將24張圖的資料洗亂，洗亂後，從0號牌到23號牌的圖組別、圖來源都會被排好，準備裝上牌。

        for (let i = array.length - 1; i > 0; i--) {
          let j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }

        //  ====測試用 在console偷看答案====
        let answer = "";
        for (let i = 0; i < array.length; i++) {
          answer += array[i][0] + "\t";
          if (i % 6 == 5) {
            answer += "\n";
          }
        }
        console.log(answer);
        //  ====測試用 在console偷看答案====
      }

      function photo_card_front_combine() {
        // 把圖裝上牌的前面(front)
        // 設定從0號牌到23號牌的圖組別、圖來源

        let fronts = document.querySelectorAll(".card .front");
        let index = 0;
        fronts.forEach((front) => {
          front.setAttribute("group", all_cards_data[index][0]);
          front.setAttribute("style", all_cards_data[index][1]);
          index++;
        });
      }

      function stack_initialize() {
        // 堆疊初始化
        stack = new Stack();
      }

      function try_matching(card_id_string) {
        // 先判斷要不要push進堆疊，有push才看堆疊滿了沒，滿了再判斷堆疊中的兩張卡的圖是否同組。
        if (stack.push(card_id_string)) {
          if (stack.check_is_full()) {
            let up_card_id = parseInt(stack.pop()); // 堆疊上方卡片ID(數字)
            let down_card_id = parseInt(stack.pop()); // 堆疊下方卡片ID(數字)

            if (
              all_cards_data[up_card_id][0] != all_cards_data[down_card_id][0]
            ) {
              //  比對兩張卡的圖是否同組
              delay()
                .then(function () {
                  return delay(1000); // 延遲ㄧ秒
                })
                .then(function () {
                  // 配對失敗，取消翻開狀態 (變回蓋牌狀態)
                  flip_card(up_card_id);
                  flip_card(down_card_id);
                });
            } else {
              // 配對成功，隱藏(消掉)卡牌。
              hidden_card(up_card_id);
              hidden_card(down_card_id);
              unused_card_qty -= 2;
            }
          }
        }
      }

      function flip_card(card_id) {
        // 把牌翻開
        $("#" + card_id).toggleClass("flipped");
      }

      function hidden_card(card_id) {
        // 隱藏(消失)卡牌
        $("#" + card_id).toggleClass("hidden");
      }

      function startTimer() {
        seconds++;

        let seconds_units = seconds % 10;
        let seconds_tens = Math.floor(seconds / 10);

        if (seconds <= 59) {
          $("#seconds_units").text(seconds_units);
          $("#seconds_tens").text(seconds_tens);
        } else if (seconds == 60) {
          seconds = 0;
          $("#seconds_units").text("0");
          $("#seconds_tens").text("0");
          minutes++;
        }

        let minutes_units = minutes % 10;
        let minutes_tens = Math.floor(minutes / 10);

        if (minutes <= 59) {
          $("#minutes_units").text(minutes_units);
          $("#minutes_tens").text(minutes_tens);
        } else if (minutes == 60) {
          minutes = 0;
          $("#minutes_units").text("0");
          $("#minutes_tens").text("0");
        }
      }

      function closeWindow() {
        $(".popup-wrap").fadeOut(200);
        $(".popup-box").removeClass("transform-in").addClass("transform-out");
        event.preventDefault();
      }

      function game_prepare() {
        // 準備遊戲

        // 洗圖順序
        shuffle_array(all_cards_data);

        // 把圖裝上牌的前面(front)
        photo_card_front_combine();

        // 堆疊初始化
        stack_initialize();
      }

      function game() {
        // 進行遊戲

        delay()
          .then(function () {
            $(".card").toggleClass("flipped");
            return delay(3000); // 延遲三秒(讓玩家先記三秒)
          })
          .then(function () {
            // 配對失敗，取消翻開狀態 (變回蓋牌狀態)
            $(".card").toggleClass("flipped");
          });

        // 計時器開跑變數
        let stopwatchStart = 0;
        $(".card").on("click", function () {
          // 點牌偵測

          // 第一次翻牌就讓計時器開跑
          if (!stopwatchStart) {
            clearInterval(interval);
            interval = setInterval(startTimer, 1000);
            stopwatchStart = 1;
          }

          // 從卡片元素抓出card id送到stack，stack會決定要不要處理。
          try_matching(this["id"]);

          if (!unused_card_qty) {
            delay()
              .then(function () {
                clearInterval(interval);
                return delay(1000); // 延遲一秒再跳出遊戲結束框
              })
              .then(function () {
                // alert("遊戲結束");

                $("#letmeopen").fadeIn(250);
                
                $("popup-box")
                  .removeClass("transform-out")
                  .addClass("transform-in");

                $(".popup-close").click(function () {
                  closeWindow();
                });
              });
            return;
          }
        });
      }

      // function end_game() {
      //   // 結束遊戲
      // }

      $(document).ready(function () {
        game_prepare();
        game();
        // end_game();
      });
    </script>
  </body>
</html>
