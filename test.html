<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
    <script src="jquery-3.7.1.js"></script>
  </head>
  <body>
    <div class="game_scene">
      <div class="left_part">
        <div class="row row0">
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row1">
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row2">
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
        <div class="row row3">
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
          <div class="card">
            <div class="front"></div>
            <div class="back"></div>
          </div>
        </div>
      </div>
      <div class="right_part"></div>
    </div>
    <script>
      // 設定卡牌資料
      const all_cards = [
        ["p00_1", "background-image: url(img/Hanafuda/p0_January_Hikari.png);"],
        ["p00_2", "background-image: url(img/Hanafuda/p0_January_Hikari.png);"],
        ["p01_1", "background-image: url(img/Hanafuda/p1_March_Hikari.png);"],
        ["p01_2", "background-image: url(img/Hanafuda/p1_March_Hikari.png);"],
        ["p02_1", "background-image: url(img/Hanafuda/p2_August_Hikari.png);"],
        ["p02_2", "background-image: url(img/Hanafuda/p2_August_Hikari.png);"],
        [
          "p03_1",
          "background-image: url(img/Hanafuda/p3_November_Hikari.png);",
        ],
        [
          "p03_2",
          "background-image: url(img/Hanafuda/p3_November_Hikari.png);",
        ],
        [
          "p04_1",
          "background-image: url(img/Hanafuda/p4_December_Hikari.png);",
        ],
        [
          "p04_2",
          "background-image: url(img/Hanafuda/p4_December_Hikari.png);",
        ],
        ["p05_1", "background-image: url(img/Hanafuda/p5_February_Tane.png);"],
        ["p05_2", "background-image: url(img/Hanafuda/p5_February_Tane.png);"],
        ["p06_1", "background-image: url(img/Hanafuda/p6_July_Tane.png);"],
        ["p06_2", "background-image: url(img/Hanafuda/p6_July_Tane.png);"],
        ["p07_1", "background-image: url(img/Hanafuda/p7_May_Tane.png);"],
        ["p07_2", "background-image: url(img/Hanafuda/p7_May_Tane.png);"],
        ["p08_1", "background-image: url(img/Hanafuda/p8_March_Kasu_2.png);"],
        ["p08_2", "background-image: url(img/Hanafuda/p8_March_Kasu_2.png);"],
        ["p09_1", "background-image: url(img/Hanafuda/p9_October_Kasu_1.png);"],
        ["p09_2", "background-image: url(img/Hanafuda/p9_October_Kasu_1.png);"],
        [
          "p10_1",
          "background-image: url(img/Hanafuda/p10_December_Kasu_2.png);",
        ],
        [
          "p10_2",
          "background-image: url(img/Hanafuda/p10_December_Kasu_2.png);",
        ],
        ["p11_1", "background-image: url(img/Hanafuda/p11_October_Tane.png);"],
        ["p11_2", "background-image: url(img/Hanafuda/p11_October_Tane.png);"],
      ];

      // 設定卡牌數量(常數)
      const card_qty = all_cards.length;

      // 檯面上剩餘卡牌數量 (未使用)
      // let unused_card_qty = card_qty;

      // 宣告堆疊
      let stack = null;

      // 宣告現在點擊的卡片元素
      let now_click_card_elem = null;

      // 宣告現在點擊的卡片front元素
      let now_click_front_elem = null;

      // 宣告現在點擊的卡片front ID (字串)
      let now_click_front_id = null;

      // 宣告現在點擊的卡片front組別 (字串)(可能不會用到)
      // let now_click_front_group = null;

      function Stack() {
        // 定義堆疊，每個element都是字串，代表front ID。
        let items = [];
        function push(element) {
          items.push(element);
        }
        function pop() {
          return items.pop();
        }
        function peek() {
          // 查看最上方的item
          if (!items.length) {
            // 要是堆疊為空，回傳空字串。
            return "";
          } else {
            return items[items.length - 1];
          }
        }
        function check_is_full() {
          if (items.length == 2) {
            return true;
          } else {
            return false;
          }
        }
        return {
          push,
          pop,
          peek,
          check_is_full,
        };
      }

      function shuffle_array(array) {
        // 發牌
        // Fisher-Yates Shuffle 演算法
        for (let i = array.length - 1; i > 0; i--) {
          let j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function card_front_data_setting(setting_data) {
        // 放牌
        // 卡片每列由左至右設定完，再設定下一列。
        let fronts = document.querySelectorAll(".card .front");
        let index = 0;
        fronts.forEach((front) => {
          front.setAttribute("id", setting_data[index][0]);
          front.setAttribute("style", setting_data[index][1]);
          index++;
        });
      }

      function stack_initialize() {
        // 堆疊初始化
        stack = new Stack();
      }

      function flip_card(card_elem) {
        // 翻牌
        $(card_elem).toggleClass("flipped");
      }

      function recover_card(card_elem) {
        // 把牌蓋回去
        $(card_elem).toggleClass("recover");
      }
      
      function hidden_card(card_elem) {
        // 把牌蓋回去
        $(card_elem).toggleClass("hidden");
      }

      function front_id_to_stack(id) {
        // 將front id塞進堆疊

        if (id == stack.peek()) {
          // 若堆疊中已有相同front id，則不允許塞進堆疊，直接return。
          console.log("同一張，不放進堆疊。");
          return;
        }

        // 沒有相同的front id
        // 先判斷堆疊是否已滿
        if (!stack.check_is_full()) {
          // 堆疊還沒滿
          console.log("不同張，放進堆疊。");
          // 翻牌
          flip_card(now_click_card_elem);
          // 塞進堆疊
          stack.push(id);
        } 

        // 塞進堆疊後，看堆疊滿了沒？
        if (stack.check_is_full()){
          // 堆疊滿了，接著判斷堆疊中兩張牌是否同組？
          // 邊判斷，邊清堆疊。

          let second_card_front_elem = document.getElementById(stack.pop());
          let second_click_card_group = second_card_front_elem.id.split("_")[0];
          let second_card_elem = $(second_card_front_elem).closest('.card');

          let first_card_front_elem = document.getElementById(stack.pop());
          let first_click_card_group = first_card_front_elem.id.split("_")[0];
          let first_card_elem = $(first_card_front_elem).closest('.card');

          if (first_click_card_group == second_click_card_group) {
            // 同組，讓兩張牌消失在畫面上。
            console.log("已清空堆疊，剛才堆疊中的兩張牌同組，讓這兩張牌消失。");
            hidden_card(first_card_elem);
            hidden_card(second_card_elem);
          } else {
            // 不同組，讓兩張牌翻回去
            
            console.log("已清空堆疊，剛才堆疊中的兩張牌不同組，將這兩張牌翻回去。");
            // recover_card(second_card_elem);  
            // recover_card(first_card_elem);
          }
        }
      }

      function game_prepare() {
        // 準備遊戲

        // 洗牌
        shuffle_array(all_cards);
        // 發牌
        card_front_data_setting(all_cards);
        // 堆疊初始化
        stack_initialize();
      }

      function game() {
        // 進行遊戲

        // 點牌偵測
        $(".card").click(function () {
          // 設定現在點擊的卡片元素
          now_click_card_elem = this;
          // 設定現在點擊的卡片front元素
          now_click_front_elem = $(this).children(".front")["0"];
          // 設定現在點擊的卡片front ID (字串)
          now_click_front_id = now_click_front_elem["id"];
          // 設定現在點擊的卡片front組別 (字串)
          // now_click_front_group = now_click_front_id.split("_")[0];

          console.log(now_click_card_elem);
          console.log(now_click_front_elem);
          console.log(now_click_front_id);
          // console.log(now_click_front_group);

          // 翻開的牌和堆疊內的牌同一張嗎(相同ID)?
          front_id_to_stack(now_click_front_id);
        });
      }

      // function end_game(){
      //   // 結束遊戲
      // }

      $(document).ready(function () {
        game_prepare();
        game();
        // end_game();
      });
    </script>
  </body>
</html>
